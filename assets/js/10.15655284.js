(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{277:function(t,a,n){"use strict";n.r(a);var s=n(38),e=Object(s.a)({},function(){var t=this,a=t.$createElement,n=t._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"migrations"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#migrations","aria-hidden":"true"}},[t._v("#")]),t._v(" Migrations")]),t._v(" "),n("p",[t._v("The migrations plugin can automatically generate and apply migrations to keep\nyour database schema up to date when changes to the model definitions occur.")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("- cmd/\n    - sqlbunny/      <- Runs sqlbunny, with your own configuration\n        - main.go\n    - migrate/       <- Runs your migrations\n        - main.go\n    - app/           <- Runs your application\n        - main.go\n- migrations/        <- Package containing migrations.\n    - store.go\n    - migration_00001.go\n- models/            <- autogenerated models package\n    - book.go        \n    - bunny_*.go\n")])])]),n("h2",{attrs:{id:"setting-up"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#setting-up","aria-hidden":"true"}},[t._v("#")]),t._v(" Setting up")]),t._v(" "),n("p",[t._v("First, make sure that the migrations plugin is enabled:")]),t._v(" "),n("div",{staticClass:"language-go extra-class"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Run")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("migration"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Plugin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("To create the "),n("code",[t._v("migrations")]),t._v(" package, run:")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("go run ./cmd/sqlbunny/main.go migration gen\n")])])]),n("p",[t._v("The first run will create the package, and the migration store in "),n("code",[t._v("migrations/store.go")]),t._v(".")]),t._v(" "),n("p",[t._v("Then, add the newly created migration store to the plugin config. This is necessary so the plugin can read the existing migrations, to diff the existing schema with the new one.")]),t._v(" "),n("div",{staticClass:"language-go extra-class"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Run")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("migration"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Plugin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        Store"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("migrations"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Store"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("h2",{attrs:{id:"generating-migrations"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#generating-migrations","aria-hidden":"true"}},[t._v("#")]),t._v(" Generating migrations")]),t._v(" "),n("p",[t._v("To generate a migration, run:")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("go run ./cmd/sqlbunny/main.go migration gen\n")])])]),n("p",[t._v("Migrations are generated according to the following algorithm:")]),t._v(" "),n("ul",[n("li",[t._v('Existing migrations are applied to a "virtual" schema. This schema represents the current state of the database.')]),t._v(" "),n("li",[t._v('The model definitions from the config are compiled into another "virtual" schema. This schema represents the desired final state of the database.')]),t._v(" "),n("li",[t._v("The two schemas are examined for differences")]),t._v(" "),n("li",[t._v("The differences are taken into a migration that converts the current schema to the desired schema.")]),t._v(" "),n("li",[t._v("The migration is written to a Go file.")])]),t._v(" "),n("div",{staticClass:"tip custom-block"},[n("p",[t._v("Generated migration files should be checked into version control (Git, SVN, etc.). They're effectively the history of your models, and keeping it intact ensures any developer or production database is able to be migrated up to the latest changes.")])]),t._v(" "),n("h2",{attrs:{id:"running-migrations"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#running-migrations","aria-hidden":"true"}},[t._v("#")]),t._v(" Running migrations")]),t._v(" "),n("p",[t._v("To run the migrations, call "),n("code",[t._v("Store.Run(ctx)")]),t._v(" on your migrations package.")]),t._v(" "),n("p",[t._v("You can do this from your main application, or you can build a third separate binary. Having a separate binary may be useful for development, so you can run migrations even when your main application code is in a state that doesn't compile.")]),t._v(" "),n("p",[t._v("Put this in "),n("code",[t._v("cmd/migrate/main.go")]),t._v(":")]),t._v(" "),n("div",{staticClass:"language-go extra-class"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" main\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"context"')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"database/sql"')]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"github.com/sqlbunny/sqlbunny/runtime/bunny"')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"github.com/sqlbunny/sqlbunny_demo/migrations"')]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tdb"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" sql"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Open")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"postgres"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"host=localhost port=5432 dbname=postgres user=postgres password=postgres sslmode=disable"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("panic")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\tctx "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Background")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tctx "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bunny"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("ContextWithDB")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" db"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\terr "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" migrations"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Store"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Run")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("panic")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("The migration store tracks which migrations have been run in the "),n("code",[t._v("migrations")]),t._v(" table. This table is created on the fly, and it's not managed by migrations itself (ie, it's not a model).")]),t._v(" "),n("p",[t._v("When running, it will read which migrations have been applied from the "),n("code",[t._v("migrations")]),t._v(" table, and then apply the missing ones (if any) in order.")]),t._v(" "),n("h2",{attrs:{id:"manual-migrations"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#manual-migrations","aria-hidden":"true"}},[t._v("#")]),t._v(" Manual migrations")]),t._v(" "),n("p",[t._v("TODO")])])},[],!1,null,null,null);a.default=e.exports}}]);